# HydroGuard：基于 CPLD/FPGA 的高可靠性水位监控系统

**项目来源：** 北京邮电大学 数字电路与逻辑设计实验（下） - 题目3

## 1. 项目概述

HydroGuard 是一个基于 VHDL 的模块化数字系统设计并实现的功能完备的水位监控、多级报警与自动控制平台。系统以 CPLD/FPGA 为核心控制器，通过超声波传感器进行高精度水位探测，并结合 LCD 屏、数码管、双色点阵和蜂鸣器提供全面的声光报警与状态反馈。

系统内置自动泄洪逻辑，并提供完整的手动干预功能，适用于需要高可靠性和实时反馈的水位监控应用。

## 2. 核心功能

### 2.1 传感与自检
* **高精度测距：** 通过驱动 HC-SR04 超声波传感器，实时捕获回波时间并将其精确换算为物理距离（mm）。
* **开机自检 (POST)：** 系统启动后，在显示启动画面后，将首先对超声波传感器执行一次功能自检。
    * **成功：** 传感器在规定时间内返回有效信号，系统进入正常监控模式。
    * **失败：** 传感器无响应或响应超时，系统将锁定在错误界面（LCD 显示 "ULTRASONIC FAIL"），以防止基于错误数据的误操作。

### 2.2 多模态信息显示
* **LCD 128x64 显示屏：** 作为主信息中心，提供一个图形化的用户界面 (UI)。
    * **启动画面：** 开机后首先居中显示项目标题及开发者信息，停留2秒。
    * **主界面：** 实时显示水位数值 (mm)、系统状态（安全、警惕、危险、泄洪）、泄洪模式（自动/手动）以及泄洪速度。
    * **高效刷新：** 采用静态标签一次性写入和动态数据增量更新的策略，避免屏幕闪烁。
* **8 位数码管：**
    * **水位显示：** 在 DISP7-DISP5 上实时显示三位数的水位值 (mm)。
    * **状态码：** 在 DISP0 上显示当前的水位状态码 (1-4)。
    * **泄洪速度：** 在 DISP2 上显示当前的泄洪速度档位 (1-3)，非泄洪模式下自动熄灭。
    * **视觉警报：** 当水位处于“危险”状态时，水位数值将以 2Hz 的频率闪烁。
* **8x8 双色 LED 点阵：**
    * **水位可视化：** 以柱状图形式直观显示当前水位，水位越高，点亮的行数越多。
    * **状态颜色编码：** 安全水位（绿色）、警惕水位（黄色）、危险及泄洪水位（红色）。
    * **泄洪动画：** 进入泄洪模式时，点阵切换为从左到右的红色竖条扫描动画，动画速度与泄洪速度档位同步。

### 2.3 报警与控制逻辑
* **多级声光报警：**
    * **蜂鸣器：** 报警声音的间隔随水位增高（警惕 -> 危险 -> 泄洪）而缩短，实现急促程度递增的听觉报警。
    * **视觉（点阵/数码管）：** 协同提供颜色变化和闪烁警示。
* **自动泄洪控制 (闭环)：**
    * 当水位超过 800mm 阈值时，系统自动进入 `DRAINING` 模式，并激活 `floodgate_open_o` 信号。
    * 当水位回落至“安全水位”时，系统自动停止泄洪，关闭信号。
* **手动干预系统：**
    * **模式切换 (SW0)：** 允许用户在“自动速度”（由水位决定）和“手动速度”之间切换。
    * **强制泄洪 (BTN7)：** 当水位处于“危险”状态时，允许按 BTN7 手动启动泄洪。在泄洪期间，可按 BTN7 随时手动停止。
    * **速度调节 (BTN2)：** 在“手动速度”模式下，按 BTN2 可循环切换 1-2-3 档泄洪速度。

## 3. 硬件需求

* **核心板：** 任意 Altera (Intel) CPLD/FPGA 开发板（支持 Quartus II / Quartus Prime）
* **传感器：** 1x HC-SR04 超声波测距模块
* **显示器：** 1x LCD12864 液晶显示屏
* **数码管：** 1x 8位共阴极 7 段数码管模块
* **点阵：** 1x 8x8 共阳极、行扫描双色 LED 点阵模块
* **音频：** 1x 蜂鸣器（有源或无源驱动）
* **输入：** 2x 瞬时按钮（BTN2, BTN7 - 低电平有效），1x 拨码开关 (SW0)

## 4. 软件架构

本项目完全使用 **VHDL** (VHDL-2008 标准) 编写，采用了自顶向下的模块化设计思想。

* `HydroGuard.vhd`: 顶层实体。负责实例化所有子模块，管理顶层系统状态机（如 `NORMAL_MONITORING` / `DRAINING` 模式切换），并整合所有并发与时序逻辑。
* `hc_sr04.vhd`: 超声波驱动模块。负责 `Trig` 脉冲的生成、`Echo` 回波的捕获，以及基于标定系数的高效距离计算。
* `lcd_12864.vhd`: 128x64 液晶驱动核心。
* `seven_segment_driver.vhd`: 8位数码管动态扫描与译码驱动模块。
* `led_matrix_driver.vhd`: 8x8 双色点阵行扫描与颜色数据解析驱动模块。
* `buzzer_driver.vhd`: 蜂鸣器 PWM 方波生成器，通过输入计数值控制音调。
* `debounce.vhd`: 通用型按键消抖模块。接收原始按键输入，输出干净的单周期脉冲信号。

## 5. 部署指南

1.  在 Quartus Prime 中新建一个项目。
2.  将本项目中的所有 `.vhd` 源文件添加至项目中。
3.  打开 Pin Planner (引脚规划器)，根据 `HydroGuard.vhd` 的顶层 `port` 列表，将每个端口信号分配到开发板原理图上对应的物理引脚。
4.  点击 "Start Compilation" (开始编译)。
5.  编译成功后，打开 "Programmer" (编程器)。
6.  将生成的 `.sof` (FPGA) 或 `.pof` (CPLD) 编程文件下载到目标设备。
